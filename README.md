tdsreduction - пайплайн для обработки длиннощелевых наблюдений на TDS (Transient Double-beam Spectrograph - двухлучевой спектрограф, установленный на 2.5-метровом телескопе Кавказской Горной Обсерватории). Пайплайн представляет из себя пакет программ, написанный на языке Python 3 и состоящий из множества модулей, которые могут работать независимо. На данный момент есть три способа работы с пайплайном: запуск модулей по отдельности с передачей всех параметров через терминал, запуск пайплайна целиком с передачей всех параметров через терминал, запуск пайплайна целиком с передачей параметров в виде YAML-файла.

## Описание отдельных модулей
Почти все модули пакета tdsreduction (находятся внутри директории ) могут быть запущены как скрипты из консоли, при этом большинство из них имеет следующие параметры, передаваемые при запуске скрипта:
- `filenames` - список имён файлов, передаваемых скрипту, разделённых пробелом. Если файлы из разных папок, необходимо передавать полное имя каждого файла (с путём к нему). Если все передаваемые файлы лежат в одной папке - достаточно указать только имена файлов без пути и использовать ключ `-d`. **Список файлов необходимо передавать после всех остальных аргументов!**
- `-d, --dir` - *необязательный ключ*, путь к папке с файлами, передаваемыми скрипту.
- `-o, --out` - *необязательный ключ*, имя файла, куда будет сохранён результат (включая путь к нему). Если файл с таким именем уже существует, он будет перезаписан. Если не указать этот ключ - файл будет сохранён с именем по умолчанию, оно указано в коде каждого конкретного скрипта.
- `-h, --help` - вывод подсказки со списком аргументов, передаваемых скрипту.

Большинство модулей для обработки калибровок имеют внутри себя следующие функции:
- *main* - функция, которая выполняется при запуске файла как скрипта. В ней содержится обработка передаваемых скрипту ключей и соответствующая настройка скрипта, а также все операции по чтению и сохранению файлов.
- *get_<имяскрипта>_file* - функция, которая из отснятых калибровочных кадров получает соответствующую калибровку (файлы калибровок имеют различную структуру, для каждой из калибровок они описаны ниже).
- *<имяскрипта>_from_file* - функция, которая из готового файла соответствующей калибровки получает *<имяскрипта>_obj* - объект, который будет использоваться другими скриптами при применении данной калибровки.
- *process_<имяскрипта>* - функция, которая применяет калибровку

#### bias.py
Модуль для получения шума считывания и супербаеса - кадра с средними начальными значениями сигнала в каждом пикселе, получаемого из серии кадров с нулевой экспозицией (как объект в них указан "dark"). Усреднение кадров производится с сигма-клиппингом: значения, выскакивающие больше, чем на 5 сигма, не учитываются при усреднении. Шум считывания считается как примерное среднеквадратичное отклонение значений супербаеса от среднего по кадру (используется оценка по медианному абсолютному отклонению), умноженное на гейн. Для ТДС гейн принимается равным единице.

Запуск скрипта: `bias.py [-h] [-d DIR] [-o OUT] filenames [filenames ...]`
Все аргументы стандартные.

Результирующий файл будет состоять из одного HDU с таким же хедером, как первый из переданных на вход скрипта файлов, в который будет добавлен ключ 'READNOISE', содержащий значение шума считывания.

#### dark.py
Модуль для построения усреднённых кадров темнового тока. Для каждого из значений экспозиции темнового тока проводится та же процедура усреднения, что при получении супербаеса. Если скрипту передан кадр супербаеса - он будет вычтен из каждого кадра "dark" до процедуры усреднения.

Запуск скрипта: `dark.py [-h] [-d DIR] [-o OUT] [-B BIAS] filenames [filenames ...]`
Нестандартный аргумент:
- `-B, --BIAS` - файл с супербайесом, полученый скриптом bias.py. Если передан - супербайес будет вычтен из всех кадров dark до операции усреднения.

Результирующий файл будет состоять из нескольких HDU, каждый из которых соответствуют среднему "dark" кадру при определённом времени экспозиции. Хедер каждого HDU - это скопированный хедер одного из "dark" кадров с этой экспозицией.

#### cosmics.py
Модуль для чистки следов космических лучей на кадре. Чистка проводится с помощью библиотеки lacosmic. Входные параметры для lacosmic: *contrast=1.5,  cr_threshold=2, neighbor_threshold=0.7, effective_gain=1*. *readnoise* берётся из bias, *background* - это сам кадр супербайеса.

Запуск скрипта: `cosmics.py [-h] [-d DIR] [-o OUT] [-B BIAS] filenames [filenames ...]`
Нестандартный аргумент:
- `-B, --BIAS` - файл с супербайесом, полученый скриптом bias.py. Если передан - супербайес будет вычтен из всех кадров до чистки от космиков. **Обязательный аргумент.**

Результирующие файлы - вычещенные от космиков входные файлы. При этом сохраняется только первый hdu, если их в файле несколько.

#### corrections.py
Модуль для исправления геометрических искажений вдоль оси X (выражается в том, что спектральные линии не прямые, а похожи на параболы). Находит на кадре линии (**при этом используется интерактивный режим, необходимо участие человека**), каждую линию фитирует полиномом второй степени (зависимость x(y)), затем коэффициенты этого полинома фитирует полиномом третьей степени (зависимость k(x)). Важно: нахождение линий в каждой строке производится с точностью до пикселя.

__Описание интерактивной части скрипта__
Через несколько секунд после запуска скрипта, пользователь увидит изображение цветных линий. Это найденные на кадре линии, линии ищутся как кластеры с помощью метода DBSCAN библиотеки sklearn. Если скрипт находит несколько очень близких линий, из них выбирается только одна. Чёрные точки - это найденные пики, которые не приписаны к линиям. После того, как окно с изображением линий будет закрыто, пользователю будет предложено изменить параметры поиска линий. Если всё устраивает - достаточно нажать Enter. Если нет - передать те параметры, которые нужно изменить (параметры передаются со знаком дефиса перед ними):
- `-l` - минимальная высота пика относительно медианного сигнала, при котором он будет считаться пиком. Этот параметр можно уменьшить, если найдено слишком мало пиков, и увеличить, если слишком много и линии путаются.
- `-d` - минимальное расстояние между двумя пиками, при котором оба они будут учитываться. Можно увеличить, если соседние линии сливаются друг с другом (но лучше для этого увеличить параметр `-k`), или уменьшить, если линий найдено мало и нужно добавить соседние.
- `-k` - вес сдвига по оси Y относительно сдвига по оси X при поиске линии. При поиске кластеров все X-координаты умножаются на это число, чтобы в один кластер не попали точки соседних линий. Если линии смешиваются - можно увеличить этот параметр, если края линий (сверху и снизу) классифицируются как другие линии - его можно уменьшить.
- `-eps` - расстояние между двумя точками, при котором они считаются соседями (нужно учитывать, что расстояние по X умножено на `k`). Если в линиях много разрывов (не найдены пики в строках),  - можно увеличить этот параметр, если много смешивающихся линий - уменьшить.
- `-clust` - количество соседей у точки, при котором она может стать центром кластера. Если много линий остаются чёрными (неклассифицированными) - можно уменьшить этот параметр, если есть линии, у которых верх и низ покрашены разными цветами (классифицированы как разные линии) - можно этот параметр увеличить.

Пока пользователь не оставит строку ввода пустой, программа будет предлагать поменять параметры. После того, как устраивающие параметры найдены, программа выведет изображение неисправленного спектра неона, с изображёнными на нём точками пиками и линиями - результаты фитирования линий полиномами. Рекомендуется приблизить несколько линий и удостовериться в корректности фитирования. После этого будет выведено изображение исправленного за искажения спектра лампы, можно удостовериться, что линии вертикальны и прямы.

Запуск скрипта: `corrections.py [-h] [-d DIR] [-o OUT] [-B BIAS] [-D DARK] [-C] filenames [filenames ...]`
Нестандартные аргументы:
- `-B, --BIAS` - файл с супербайесом, полученый скриптом bias.py. Если передан - супербайес будет вычтен из всех кадров спектров лампы до поиска линий.
- `-D, --DARK` - файл с темновыми токами, полученный скриптом dark.py. Если передан - токи, соответствующие экспозиции кадров лампы, будут вычтены после супербайеса (если передан), но перед поиском линий.
- `-C, --COSMICS` - логический аргумент (не требует файлов после себя), если передан - будет проведена чистка следов космических лучей перед поиском линий.

Результирующий файл содержит два HDU. Первый HDU - карта интерполяции. В каждой строчке хранятся координаты (в пикселях оси X), на которые необходимо интерполировать значения потоков в пикселях этой строчки. Второй HDU - исправленный спектр неона.


#### flat.py
Moдуль для обработки кадров плоского поля (засветка спектрографа лампой без спектральных линий). Скрипт усредняет несколько центральных строк кадра лампы, затем запускается интерактивный режим (**необходимо участие пользователя**) для подбора сплайна, наилучшим образом описывающего спектр лампы. После этого создаётся опорный кадр спектра лампы (с учётом геометрических искажений), если бы засветка была однородной вдоль щели и не было бы фрингов. Опорный кадр делится на снятый кадр и получается кадр коэффициентов, на которые необходимо домножить получаемые спектры, чтобы учесть неоднородность засветки и фринги.

__описание интерактивной части скрипта__
После запуска скрипта пользователь увидит изображение спектра лампы и сплайна, которым он фитируется. Сплайн должен примерно соответствовать спектру, но игнорировать фринги (небольшие неоднородности 30-60 пикселей в ширину). После того, как окно с графиками будет закрыто, пользователю будет предложено изменить параметр, определяющий точность сплайна. Если всё устраивает - достаточно нажать Enter, если нет - ввести новое значение параметра, например `-p 8`. Чем меньше этот параметр - тем точнее сплайн соответствует спектру.

Запуск скрипта: `flat.py [-h] [-d DIR] [-o OUT] [-X GEOMETRY] [-B BIAS] [-D DARK] filenames [filenames ...]`
Нестандартные аргументы:
- `-B, --BIAS` - файл с супербайесом, полученый скриптом bias.py. Если передан - супербайес будет вычтен из всех кадров спектров лампы до получения кадра коэффициентов.
- `-D, --DARK` - файл с темновыми токами, полученный скриптом dark.py. Если передан - токи, соответствующие экспозиции кадров лампы, будут вычтены после супербайеса (если передан), но перед проведением обработки. *Так как у кадров плоского поля как правило короткие экспозиции, этот аргумент обычно не нужен*
- `-X, --GEOMETRY` - файл с картой интерполяции, полученной скриптом corrections.py. Без него результат обработки кадров плоского поля будет некорректным.

Результирующий файл - кадр коэффициентов, на которые необходимо домножить полученные спектры.

#### dispersion.py
Скрипт для получения дисперсионного уравнения (преобразования координаты в пикселях в координату в длинах волн). Для его работы необходимы кадры лампы с линейчатым спектром и известные длины волн спектральных линий этой лампы, файлы спектров лампы являются частью пакета tdsreduction. Первая его часть устроена так же, как скрипт corrections.py и нужна для поиска спектральных линий. После этого пользователю будет нужно вручную провести кросс-идентификацию нескольких линий на кадре с линиями опорного (известного) спектра. Достаточно указать 5-7 линий, остальные программа идентифицирует сама. После этого программа уточняет положение пиков в каждой строчке кадра, это может занять 5-15 секунд, и получает двумерное дисперсионное уравнение. С использованием этого уравнения создаётся карта интерполяции, подобная карте интерполяции из скрипта corrections.py, но помимо более точной геометрической коррекции ставящая в соответствие пиксель-координате лямбда-координату.

__описание интерактивной части скрипта__
В скрипте dispersion.py две интерактивные части. Первая повторяет интерактивную часть скрипта corrections.py, так что здесь приводится только описание второй части.
В некоторый момент работы скрипта пользователь увидит графики двух спектров: Reference и Observed. Необходимо поочерёдно нажимать левой кнопкой мыши на пик на верхней части (Reference) и на соответствующий пик в нижней части (Observed). Достаточно обозначить 5-7 пиков, равномерно распределённых по спектру. Рекомендуется в том числе выбрать крайний правый и крайний левый пик для более точного построения дисперсионного уравнения.

Запуск скрипта: `dispersion.py [-h] [-d DIR] [-o OUT] [-X GEOMETRY] [-B BIAS] [-D DARK] [-C] [-F FLAT] filenames [filenames ...]`
Нестандартные аргументы:
- `-B, --BIAS` - файл с супербайесом, полученый скриптом bias.py. Если передан - супербайес будет вычтен из всех кадров спектров лампы.
- `-D, --DARK` - файл с темновыми токами, полученный скриптом dark.py. Если передан - токи, соответствующие экспозиции кадров лампы, будут вычтены после супербайеса (если передан), но перед проведением обработки.
- `-X, --GEOMETRY` - файл с картой интерполяции, полученной скриптом corrections.py. *Этот аргумент игнорируется текущей версией программы и добавлен для совместимости со старыми и будущими версиями*
- `-C, --COSMICS` - логический аргумент (не требует файлов после себя), если передан - будет проведена чистка следов космических лучей перед поиском линий. Иногда без него программа даёт лучший результат.
- `-F, --FLAT` - файл с коэффициентами, описывающими неоднородность засветки, полученный скриптом flat.py. Если передан - будет проведена коррекция за неоднородность засветки до поиска линий.

Результирующий файл состоит из двух hdu. Первый - карта длин волн, второй - преобразованный в соответствии с этой картой спектр неона. В хедере второго файла хранится информация о шаге по длинам волн, ошибке определения длины волны и среднем по кадру FWHM.

#### distorsion.py
Скрипт для учёта дисторсии (геометрических искажений вдоль оси Y). Для его работы необходимы кадры с отснятыми на разных точках щели яркими объектами. Лучше всего подойдёт звезда-стандарт. Программа работает так же, как и скрипт corrections.py, c тем отличием, что коррекции проводятся вдоль другой оси.

Запуск скрипта: `distorsion.py [-h] [-d DIR] [-o OUT] [-B BIAS] [-D DARK] [-C] [-W WAVELENGTHS] [-F FLAT] filenames [filenames ...]`
Нестандартные аргументы:
- `-B, --BIAS` - файл с супербайесом, полученый скриптом bias.py. Если передан - супербайес будет вычтен из всех кадров.
- `-D, --DARK` - файл с темновыми токами, полученный скриптом dark.py. Если передан - токи, соответствующие экспозиции кадров лампы, будут вычтены после супербайеса (если передан), но перед проведением обработки.
- `-W, --WAVELENGTHS` - файл с картой длин волн, **должет быть тот же файл, что будет использоваться для объекта!**
- `-C, --COSMICS` - логический аргумент (не требует файлов после себя), если передан - будет проведена чистка следов космических лучей перед поиском линий.
- `-F, --FLAT` - файл с коэффициентами, описывающими неоднородность засветки, полученный скриптом flat.py. Если передан - будет проведена коррекция за неоднородность засветки.

Результирующий файл - карта коррекции геометрических искажений вдоль оси Y. В хэдере есть два нестандартных ключа: 'CRPIX2A' и 'CRPIX2B'. Это референс-точки, одна из которых находится по центру кадра, вторая - на краю. Необходимы, чтобы корректно сшить красный и синий каналы.

#### pipeline.py
Скрипт, который с использованием полученных остальными скриптами файлов калибровок проводит обработку отснятых спектров научных объектов. Порядок проведения обработки следующий: вычитание баеса -> подсчёт темнового тока на экспозицию объекта и вычитание темнового тока -> учёт неоднородности засветки и фрингов -> удаление космиков -> перевод координат в длины волн и исправление геометрических искажений -> учёт дисторсии -> вычитание неба.

Запуск скрипта: `pipeline.py [-h] [-d DIR] [-c CAL] [-y YAML] [-o OUT] [-B BIAS] [-D DARK] [-F FLAT] [-C] [-X GEOMETRY] [-Y DISTORSION] [-W WAVELENGTH] [-S [SKY ...]] [-U] filenames [filenames ...]`
Описание всех аргументов:
- `-h` - вызов подсказки по использованию ключей скрипта
- `-d` - директория, в которой хранятся сырые файлы **спектров объекта**
- `-c` - директория, в которой хранятся файлы калибровок
- `-y` - YAML-файл с конфигурацией, описан в другом разделе README
- `-o` - имя результирующего файла; если на обработку передано несколько файлов и при этом не был использован ключ `-U`, то к имени файла, переданного с ключом `-o` будет добавлен индекс 0, 1, ...
- `-B, --BIAS` - файл с супербайесом, полученный скриптом bias.py 
- `-D, --DARK` - файл с темновыми токами, полученный скриптом dark.py
- `-F, --FLAT` - файл с коэффициентами коррекции неоднородности засветки, полученный скриптом flat.py
- `-C, --COSMICS` - ключ без аргумента, если указан - будет проведена чистка космиков
- `-X, --GEOMETRY` - файл с картой коррекции геометрических искажений вдоль оси X, полученный скриптом corrections.py. **Не использовать этот ключ, если используется ключ -W**
- `-Y, --DISTORSION` - файл с картой коррекции геометрических искажений вдоль оси Y, полученный скриптом distorsion.py.
- `-W, --WAVELENGTH` - файл с картой длин волн, полученный скриптом dispersion.py.
- `-U, --SUMM` - ключ без аргумента, если указан - будет проведено суммирование всех кадров объекта.
- `-S, --SKY` - вычитание неба. На данный момент ключ не используется и оставлен для совместимости с предыдущими и будущими версиями.

В результате выполнения скрипта будут созданны фитс-файлы, содержащие обработанные спектра объекта. Если был передан ключ -U, то файл будет только один. Каждый файл содержит три HDU: первый - обработанный спектр, второй - соответствующие ошибки, третий - маска, где "плохие" пиксели имеют значение 1, а "хорошие" - 0. Плохими являются пиксели, в которых на каком-либо этапе обработки возникли  отрицательные значения; те, которые содержали следы космических лучей; те, в которых SNR меньше 1. 

#### sky.py
Скрипт для вычитания спектра неба из научных кадров. Его следует запускать после всех остальных калибровок, очень важно, чтобы линии неба на кадре были прямыми. Скрипт обрабатывает 1 кадр за раз. Для каждого столбца кадра строится полином второй степени, описывающий спектр неба в этом столбце. Полученный таким образом спектр неба вычитается из кадра.

Запуск скрипта: `sky.py [-h] [-y YSKY [YSKY ...]] [-o OUT] [-s SKYFILE] filename`
Описание аргументов:
- `-y, --ysky` - последовательность из чётного количества целых чисел, обозначающих границы областей (Y-координаты), которые будут использованы для построения спектра неба.
- `-o, --out` - имя файла (включая путь к нему), в который будет сохранён спектр объекта с вычтенным небом.
- `-s, --skyfile` - имя файла, куда будет сохранён спектр неба. Если не указывать - спектр неба не будет сохранён.

Результирующий файл будет иметь такую же структуру, как входной. В частности, будут учтены и изменены hdu с ошибками и маской, если они были в исходном файле.
